Title: DNS resolution problem - dig working, ping not
Date: 2013-05-11 16:28
Author: docent
Category: tech
Tags: avahi, dig, dns, ping
Slug: dns-resolution-problem-dig-working-ping-not
Status: published

<!--:en-->Today I was reconfiguring my internal laptop network as I use
virtual machines a lot (KVM ftw) and using **/etc/hosts** was not
scaling anymore. I could use DNSmasq but I prefer BIND - so I installed
& chrooted it, and configured as caching-name server that properly
resolv my internal zone 'local' (as I use adresses like 'git.local' or
'dev1.local' or whatever). Next I had to make NetworkManager to use this
local DNS in the first place instead of those given from DHCP. I could
of course edit properly **/etc/resolv.conf** and protect it with
immutable attribute but I suppose, that NM developers didn't take it
into consideration, that resolv.conf would be unwritable and hell knows
what would happen then. So I added:

``` {.font:droid-sans-mono .font-size:13 .lang:sh .decode:true}
DNS1=127.0.0.1
DNS2=8.8.8.8
DNS3=8.8.4.4
```

To the **/etc/sysconfig/network-scripts/ifcfg-Auto\_WLANname** and
things were ok - after restarting network I had what i wanted to have in
**/etc/resolv.conf**. I resolved VPN resolving problem in a similar way.

So now I wanted to start my work with VMs and it appeared that I
couldn't make a connection to any of those:

``` {.font:droid-sans-mono .font-size:13 .lang:sh .decode:true}
[docent@docent-toshiba ~]$ ssh_git
ssh: Could not resolve hostname git.local: Name or service not known
```

Weird... And check this:

``` {.font:droid-sans-mono .font-size:13 .lang:sh .decode:true}
[docent@docent-toshiba ~]$ cat /etc/resolv.conf
# Generated by NetworkManager
search local
nameserver 127.0.0.1
nameserver 8.8.8.8
nameserver 8.8.4.4
```

So WTF with this DNS?

``` {.font:droid-sans-mono .font-size:13 .lang:sh .decode:true}
[docent@docent-toshiba ~]$ dig +short git.local
192.168.122.14
```

This time WTF was much bigger. Local DNS appears to be working
correctly. So I thought that this Fedora claimed that won't be resolving
'local' adresses via DNS. Just to confirm this idea I used
tcpdump:  "**tcpdump -n port 53" - in the meantime trying to ping
'git.local' host. And nothing there - tcpdump was silent. bingo - Fedora
was not using DNS at all to resolve this one. So why? Let's see:**

``` {.font:droid-sans-mono .lang:sh .decode:true}
[docent@docent-toshiba ~]$ strace -e poll,select,connect,recvfrom,sendto ping git.local
connect(3, {sa_family=AF_FILE, sun_path="/var/run/nscd/socket"}, 110) = -1 ENOENT (No such file or directory)
connect(3, {sa_family=AF_FILE, sun_path="/var/run/nscd/socket"}, 110) = -1 ENOENT (No such file or directory)
connect(3, {sa_family=AF_FILE, sun_path="/var/run/avahi-daemon/socket"}, 110) = 0
ping: unknown host git.local
+++ exited with 2 +++
```

Ok - we have nscd in the first way (which is not running on my laptop)
and next we have Avahi... but where the hell is DNS? Let's see
**/etc/nsswitch.conf**:

``` {.font:droid-sans-mono .font-size:13 .lang:sh .decode:true}
hosts:      files mdns4_minimal [NOTFOUND=return] dns myhostname
```

Ha - now everything is clear! You can read about Avahi, MDNS and 'local'
domains here: <http://avahi.org/wiki/AvahiAndUnicastDotLocal>

Solution? There are two. Firstly we could just replace above
nsswitch.conf entry with the following (of course only when NOT using
Avahi):

``` {.font:droid-sans-mono .font-size:13 .lang:sh .decode:true}
hosts:      files dns myhostname
```

Second solution - we could reconfigure Avahi - just as You can read in
the above URL:

``` {.font:droid-sans-mono .font-size:13 .lang:sh .decode:true}
#/etc/avahi/avahi-daemon.conf
[server]
domain-name=.alocal
```

Now only restart Avahi, web browsers and everything should be working
fine.<!--:--><!--:pl-->Trochę dziś siedziałem nad rekonfiguracją
wewnętrznej sieci wirtualnej w laptopie - mam sporo wirtualek, więc
używanie wpisów w **/etc/hosts** już nie wystarczało. DNSmasq mógłby
rozwiązać problem, jednak osobiście wolę BINDa - zainstalowałem więc,
zchrootowałem, skonfigurowałem jako caching-name server i dodałem
obsługę strefy 'local' (jako, że używam adresów z taką właśnie końcówką:
**git.local, dev1.local** etc). Miałem jeszcze trochę zabawy z
konfiguracją NetworkManagera (Fedora 17), który to nadpisuje
**/etc/resolv.conf** - początkowo chciałem temu plikowi nadać atrybut
immutable (**chattr +i**) tak żeby się NM odczepił, ale to mało koszerne
- przypuszczam, że developerzy NM nie brali pod uwagę takiego podejścia
użytkownika, więc wpadłbym w bliżej niekreślony wyjątek. Dodałem więc
wpisy:

``` {.lang:sh .decode:true}
DNS1=127.0.0.1
DNS2=8.8.8.8
DNS3=8.8.4.4
```

Do **/etc/sysconfig/network-scripts/ifcfg-Auto\_WLANname** i zaczęło to
śmigać - po restarcie połączenia **/etc/resolv.conf** zawierał to co
chciałem. Podobnie rozwiązałem problem resolvowania w trakcie połączenia
z VPNem.

No i gdy zaczynałem w końcu pracę, okazało się, że nie mogę się
podłączyć do VMki:

``` {.lang:sh .decode:true}
[docent@docent-toshiba ~]$ ssh_git
ssh: Could not resolve hostname git.local: Name or service not known
```

Dziwna przypadłość. A proszę co tu mamy:

``` {.lang:sh .decode:true}
[docent@docent-toshiba ~]$ cat /etc/resolv.conf
# Generated by NetworkManager
search local
nameserver 127.0.0.1
nameserver 8.8.8.8
nameserver 8.8.4.4
```

No to wtf z tym DNSem?

``` {.lang:sh .decode:true}
[docent@docent-toshiba ~]$ dig +short git.local
192.168.122.14
```

Teraz więc spory WTF - DNS lokalny działa poprawnie. Hmmm.. Zacząłem
podejrzewać, że mój system nagle stwierdził, że domeny 'local' to on nie
będzie resolwował za pomocą owego lokalnego DNSa. Aby to potwierdzić w
ruch poszedł tcpdump: "**tcpdump -n port 53"** - w międzyczasie próbując
pingować adres 'git.local' - i zupełnie nic tcpdump nie wypluł. Skoro
więc ping nie chciał resolvować za pomocą DNSa to za pomocą czego?
Oczywistą oczywistością jest **/etc/hosts** ale co więcej? Tym razem
strace:

``` {.lang:sh .decode:true}
[docent@docent-toshiba ~]$ strace -e poll,select,connect,recvfrom,sendto ping git.local
connect(3, {sa_family=AF_FILE, sun_path="/var/run/nscd/socket"}, 110) = -1 ENOENT (No such file or directory)
connect(3, {sa_family=AF_FILE, sun_path="/var/run/nscd/socket"}, 110) = -1 ENOENT (No such file or directory)
connect(3, {sa_family=AF_FILE, sun_path="/var/run/avahi-daemon/socket"}, 110) = 0
ping: unknown host git.local
+++ exited with 2 +++
```

No i jasne - mamy tu nscd (którego u mnie na laptopie brak), a później
Avahi - hmm.. a gdzie DNS? No to rzućmy okiem na **/etc/nsswitch.conf**:

``` {.lang:sh .decode:true}
hosts:      files mdns4_minimal [NOTFOUND=return] dns myhostname
```

No i sprawy stają się jasne - żeby się nie rozpisywać odsyłam
tutaj: <http://avahi.org/wiki/AvahiAndUnicastDotLocal>

Rozwiązanie? Są dwa. Albo zmieniamy wpis w /etc/nsswitch.conf na taki
jak poniżej (czyli po prostu przestajemy polegać na resolvowaniu
adresacji via avahi - jak tego nie używamy to dobre rozwiązanie):

``` {.lang:sh .decode:true}
hosts:      files dns myhostname
```

A drugie to rekonfiguracja Avahi tak jak opisano w powyższym linku:

``` {.lang:sh .decode:true}
#/etc/avahi/avahi-daemon.conf
[server]
domain-name=.alocal
```

Po czym wykonujemy restart usługi i czyszczenie cache
przeglądarek.<!--:-->
