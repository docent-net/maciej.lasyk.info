<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Many craft. Wow. Such create</title><link>http://maciej.lasyk.info/</link><description></description><atom:link href="http://maciej.lasyk.info/feeds/tag/iscsi.rss.xml" rel="self"></atom:link><lastBuildDate>Wed, 18 Feb 2015 00:00:00 +0100</lastBuildDate><item><title>Dracut, netboot and default gateway in RHEL/CentOS 7</title><link>http://maciej.lasyk.info/2015/Feb/18/dracut-netboot-and-default-gateway-in-rhelcentos-7/</link><description>&lt;p&gt;&lt;center&gt;&lt;img alt="RHEL" src="http://maciej.lasyk.info/images/rhel-logo-small.png" /&gt;&lt;/center&gt;&lt;/p&gt;
&lt;h3&gt;WAT?&lt;/h3&gt;
&lt;p&gt;Ok, so I've rolled up a new host and made it boot OS from the iSCSI drive.
Great. I have 4 NICs in this box.&lt;/p&gt;
&lt;p&gt;After booting machine default gateway was set up on the iSCSI network. Weird,
but ok - I tried to change that with:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Setting up a gateway in &lt;strong&gt;/etc/sysconfig/network&lt;/strong&gt; by entering &lt;strong&gt;GATEWAY&lt;/strong&gt;
  param; didn't work, still defroute on iSCSI NIC&lt;/li&gt;
&lt;li&gt;Setting up &lt;strong&gt;DEFROUTE="no"&lt;/strong&gt; in /etc/sysconfig/network-scripts/ifcfg-eno2
  (the iSCSI NIC). Didn't work, still defroute on iSCSI NIC&lt;/li&gt;
&lt;li&gt;Use "nmcli" to setup &lt;strong&gt;ipv4.never-default&lt;/strong&gt; for the iSCSI NIC. Didn't work -
  this only rewrites ifcfg* script adding DEFROUTE param&lt;/li&gt;
&lt;/ul&gt;
&lt;h3&gt;So What?&lt;/h3&gt;
&lt;p&gt;Yup, things were going weirdo and honestly I left this for a while as I simply
didn't find the answer - even after debugging the
/etc/sysconfig/network-scripts/* scripts. Something - not NetworkManager - was
overwriting the default route during boot after NetworkManager did it's job.&lt;/p&gt;
&lt;p&gt;I came back to this problem after while and poked around this one ifcfg config
for the iSCSI NIC:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="c"&gt;# Generated by dracut initrd&lt;/span&gt;
&lt;span class="nv"&gt;DEVICE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;eno2&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;ONBOOT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;yes
&lt;span class="nv"&gt;NETBOOT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;yes
&lt;span class="nv"&gt;UUID&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;whatevercdff28f030fd&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;BOOTPROTO&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;none
&lt;span class="nv"&gt;IPADDR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;192.168.1.2&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;GATEWAY&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;192.168.1.1&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;NETMASK&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;255.255.255.0&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;HWADDR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;00:22:10:d5:a2:6d&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;TYPE&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;Ethernet
&lt;span class="nv"&gt;NAME&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;eno2&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And finally I payed attention to this comment: &lt;strong&gt;Generated by dracut initrd&lt;/strong&gt;.
While installing this host I had to reconfigure dracut a little bit to make 
grub boot this OS from network via iSCSI (I wrote about &lt;a href="http://maciej.lasyk.info/2015/Feb/09/iscsi-boot-in-rhelcentos7-broken/"&gt;it here&lt;/a&gt; 
as this is a bug in CentOS/RHEL7). In &lt;strong&gt;/etc/default/grub&lt;/strong&gt; I entered:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;GRUB_TIMEOUT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;5
&lt;span class="nv"&gt;GRUB_DISTRIBUTOR&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;$(sed &amp;#39;s, release .*$,,g&amp;#39; /etc/system-release)&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;GRUB_DEFAULT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;saved
&lt;span class="nv"&gt;GRUB_DISABLE_SUBMENU&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt;
&lt;span class="nv"&gt;GRUB_TERMINAL_OUTPUT&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;console&amp;quot;&lt;/span&gt;
&lt;span class="nv"&gt;GRUB_CMDLINE_LINUX&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;ip=192.168.1.2::192.168.1.1:255.255.255.0:[...]&lt;/span&gt;
&lt;span class="s2"&gt;GRUB_DISABLE_RECOVERY=&amp;quot;&lt;/span&gt;&lt;span class="nb"&gt;true&lt;/span&gt;&lt;span class="err"&gt;&amp;quot;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;That's it! This iSCSI network is a simple P2P connection, so it does not need
the gateway there! Basing on &lt;a href="http://people.redhat.com/harald/dracut.html#id536255"&gt;this article&lt;/a&gt;
the proper format for dracut is:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="nv"&gt;ip&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&amp;lt;client-IP&amp;gt;:&lt;span class="o"&gt;[&lt;/span&gt; &amp;lt;server-id&amp;gt; &lt;span class="o"&gt;]&lt;/span&gt;:&amp;lt;gateway-IP&amp;gt;:
    &amp;lt;netmask&amp;gt;:&amp;lt;client_hostname&amp;gt;:&amp;lt;interface&amp;gt;:&lt;span class="o"&gt;{&lt;/span&gt;none|off&lt;span class="o"&gt;}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;So I simply removed the gateway &lt;strong&gt;192.168.1.1&lt;/strong&gt; from the grub default config, 
regenerated grub with:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;grub2-mkconfig -o /boot/grub2/grub.cfg
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;And after reboot my default gateway was set up exactly like I configured it in 
&lt;strong&gt;/etc/sysconfig/network&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;Yes - that was truly pain in the ass!&lt;/p&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Maciej Lasyk</dc:creator><pubDate>Wed, 18 Feb 2015 00:00:00 +0100</pubDate><guid>tag:maciej.lasyk.info,2015-02-18:2015/Feb/18/dracut-netboot-and-default-gateway-in-rhelcentos-7/</guid><category>rhel</category><category>centos</category><category>iscsi</category><category>boot</category><category>netboot</category><category>dracut</category><category>network</category></item><item><title>iSCSI boot in RHEL/CentOS7 broken</title><link>http://maciej.lasyk.info/2015/Feb/09/iscsi-boot-in-rhelcentos7-broken/</link><description>&lt;p&gt;&lt;center&gt;&lt;img alt="RHEL" src="http://maciej.lasyk.info/images/rhel-logo-small.png" /&gt;&lt;/center&gt;&lt;/p&gt;
&lt;h3&gt;WAT?&lt;/h3&gt;
&lt;p&gt;Today while rolling up new host in my company I hit the following issue after
successfully installing CentOS7 on remote iSCSI drive. I just rebooted the
machine and after GRUB done it's job I just got:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span class="o"&gt;[&lt;/span&gt;   2.375332&lt;span class="o"&gt;]&lt;/span&gt; i8042: No controller found
&lt;span class="o"&gt;[&lt;/span&gt;   2.592960&lt;span class="o"&gt;]&lt;/span&gt; dracut: FATAL: For argument 
    &lt;span class="s1"&gt;&amp;#39;ip=::::localhost.localdomain:eno1: none&amp;#39;&lt;/span&gt;&lt;span class="se"&gt;\n&lt;/span&gt;Value &lt;span class="s1"&gt;&amp;#39;none&amp;#39;&lt;/span&gt; 
    without static configuration does not make sanse
&lt;span class="o"&gt;[&lt;/span&gt;   2.593074&lt;span class="o"&gt;]&lt;/span&gt; dracut: Refusing to &lt;span class="k"&gt;continue&lt;/span&gt;
&lt;span class="o"&gt;[&lt;/span&gt;   3.197719&lt;span class="o"&gt;]&lt;/span&gt; System halted.
&lt;/pre&gt;&lt;/div&gt;


&lt;h3&gt;What's that?&lt;/h3&gt;
&lt;p&gt;The answer is &lt;a href="https://access.redhat.com/solutions/905003"&gt;here&lt;/a&gt;. Simply
installer is broken and it creates broken grub entry for iSCSI nodes.&lt;/p&gt;
&lt;h3&gt;How to fix this?&lt;/h3&gt;
&lt;p&gt;There're many ways. I just rebooted the box, entered the grub edit mode and
fixed the boot param replacing:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;linux16 /vmlinuz-3.10.0-123.el7.x86_64 &lt;span class="o"&gt;[&lt;/span&gt;...&lt;span class="o"&gt;]&lt;/span&gt; 
    vconsole.font&lt;span class="o"&gt;=&lt;/span&gt;latarcyrheb-sun16 
    &lt;span class="nv"&gt;ip&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;::::localhost.localdomain:eno1:none &lt;span class="o"&gt;[&lt;/span&gt;...&lt;span class="o"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;with this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;linux16 /vmlinuz-3.10.0-123.el7.x86_64 &lt;span class="o"&gt;[&lt;/span&gt;...&lt;span class="o"&gt;]&lt;/span&gt; 
    vconsole.font&lt;span class="o"&gt;=&lt;/span&gt;latarcyrheb-sun16 
    &lt;span class="nv"&gt;ip&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;192.168.1.15::192.168.1.1:255.255.252.0:localhost.localdomain:eno1:none &lt;span class="o"&gt;[&lt;/span&gt;...&lt;span class="o"&gt;]&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Where &lt;strong&gt;192.168.1.15&lt;/strong&gt; is the initiator IP addr and &lt;strong&gt;192.168.1.1&lt;/strong&gt; is the 
gateway IP.&lt;/p&gt;
&lt;p&gt;Of course that above is just a way to successfully boot into the system. After 
boot the grub2.cfg is still broken so now it's the time for a permanent
solution:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Fix above again in &lt;strong&gt;/etc/sysconfig/grub&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;Rebuild the grub configuration: &lt;strong&gt;&lt;em&gt;grub2-mkconfig -o /boot/grub2/grub.cfg&lt;/em&gt;&lt;/strong&gt;&lt;/li&gt;
&lt;li&gt;That's all. Just reboot and confirm it's working fine&lt;/li&gt;
&lt;/ul&gt;</description><dc:creator xmlns:dc="http://purl.org/dc/elements/1.1/">Maciej Lasyk</dc:creator><pubDate>Mon, 09 Feb 2015 00:00:00 +0100</pubDate><guid>tag:maciej.lasyk.info,2015-02-09:2015/Feb/09/iscsi-boot-in-rhelcentos7-broken/</guid><category>rhel</category><category>centos</category><category>iscsi</category><category>boot</category><category>netboot</category></item></channel></rss>