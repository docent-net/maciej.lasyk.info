<!DOCTYPE html>
<html lang="en">
<head>
        <title>Many craft. Wow. Such create : libvirt-daemon-driver-storage bug in Centos 7</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="../../../../theme/css/main.css" type="text/css" />
        <link href="../../../../" type="application/atom+xml" rel="alternate" title="Many craft. Wow. Such create ATOM Feed" />
        <link href="../../../../feeds/rss.xml" type="application/atom+xml" rel="alternate" title="Many craft. Wow. Such create RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../../../css/ie.css"/>
                <script src="../../../../js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="../../../../css/ie6.css"/><![endif]-->

</head>

<body>
	<div id="wrap" style="width:850px">
	    <div id="container" style="width:560px">


            <div class="entry">
        
<header>
<h1><a href="../../../.." id="site-title">  </a>         <a href="../../../../2015/Apr/06/libvirt-daemon-driver-storage-bug-in-centos-7/" id="page-title">libvirt-daemon-driver-storage bug in Centos 7</a></h1>
<time datetime="2015-04-06T00:00:00+02:00">Mon 06 April 2015</time></header>
<article>
    <p><center><img alt="libvirt" src="../../../../images/libvirt.png" /></center></p>
<h1>failed to load module libvirt_driver_storage.so</h1>
<p>Today I was installing
<a href="http://libguestfs.org/virt-sysprep.1.html">virt-sysprep</a> tool on one of KVM
hosts. When this was done I couldn't list VMs anymore using <strong>virsh</strong>:</p>
<div class="highlight"><pre><span></span><span class="o">[</span>root@host1 ~<span class="o">]</span><span class="c1"># virsh list --all</span>
<span class="o">[</span>454/564<span class="o">]</span>
 Id    Name                           State
 ----------------------------------------------------
 <span class="sb">```</span>

Hmm that<span class="err">&#39;</span>s not normal obsiously. Checked the **libvirtd** status:

<span class="sb">```</span>bash
<span class="o">[</span>root@host1 ~<span class="o">]</span><span class="c1"># service libvirtd status</span>
Redirecting to /bin/systemctl status  libvirtd.service
libvirtd.service - Virtualization daemon
   Loaded: loaded <span class="o">(</span>/usr/lib/systemd/system/libvirtd.service<span class="p">;</span> enabled<span class="o">)</span>
   Active: active <span class="o">(</span>running<span class="o">)</span> since Mon 2015-04-06 15:43:55 CEST<span class="p">;</span> 1h 16min ago
     Docs: man:libvirtd<span class="o">(</span>8<span class="o">)</span>
           http://libvirt.org
 Main PID: <span class="m">21191</span> <span class="o">(</span>libvirtd<span class="o">)</span>
   CGroup: /system.slice/libvirtd.service
           ├─ <span class="m">5865</span> /sbin/dnsmasq --conf-file<span class="o">=</span>/var/lib/libvirt/dnsmasq/default.conf
           └─21191 /usr/sbin/libvirtd

...
Apr <span class="m">06</span> 17:01:42 host1.devops.ent libvirtd<span class="o">[</span>6254<span class="o">]</span>: failed to load module 
/usr/lib64/libvirt/connection-driver/libvirt_driver_storage.so 
/usr/lib64/libvirt/connection-driver/libvirt_driver_storage.so: symbol 
dm_task_get_info_with_deferred_remove, version Base not defined in file 
libdevmapper.so.1.02 with link <span class="nb">time</span> reference
Apr <span class="m">06</span> 17:01:42 host1.devops.ent libvirtd<span class="o">[</span>6254<span class="o">]</span>: failed to load module 
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so 
/usr/lib64/libvirt/connection-driver/libvirt_driver_qemu.so: undefined 
symbol: virStorageFileCreate
...
</pre></div>


<p>I confirmed that installing <strong>virt-sysprep</strong> caused also upgrading libvirtd related packages:</p>
<div class="highlight"><pre><span></span> Updated     libvirt-1.1.1-29.el7_0.7.x86_64                         @updates
    Update              1.2.8-16.el7_1.2.x86_64                         @updates
    Updated     libvirt-client-1.1.1-29.el7_0.7.x86_64                  @updates
    Update                     1.2.8-16.el7_1.2.x86_64                  @updates
    Updated     libvirt-daemon-1.1.1-29.el7_0.7.x86_64                  @updates
    Update                     1.2.8-16.el7_1.2.x86_64                  @updates
    Updated     libvirt-daemon-config-network-1.1.1-29.el7_0.7.x86_64   @updates
    Update                                    1.2.8-16.el7_1.2.x86_64   @updates
    Updated     libvirt-daemon-config-nwfilter-1.1.1-29.el7_0.7.x86_64  @updates
    Update                                     1.2.8-16.el7_1.2.x86_64  @updates
    Updated     libvirt-daemon-driver-interface-1.1.1-29.el7_0.7.x86_64 @updates
    Update                                      1.2.8-16.el7_1.2.x86_64 @updates
    Updated     libvirt-daemon-driver-lxc-1.1.1-29.el7_0.7.x86_64       @updates
    Update                                1.2.8-16.el7_1.2.x86_64       @updates
    Updated     libvirt-daemon-driver-network-1.1.1-29.el7_0.7.x86_64   @updates
    Update                                    1.2.8-16.el7_1.2.x86_64   @updates
    Updated     libvirt-daemon-driver-nodedev-1.1.1-29.el7_0.7.x86_64   @updates
    Update                                    1.2.8-16.el7_1.2.x86_64   @updates
    Updated     libvirt-daemon-driver-nwfilter-1.1.1-29.el7_0.7.x86_64  @updates
    Update                                     1.2.8-16.el7_1.2.x86_64  @updates
    Updated     libvirt-daemon-driver-qemu-1.1.1-29.el7_0.7.x86_64      @updates
    Update                                 1.2.8-16.el7_1.2.x86_64      @updates
    Updated     libvirt-daemon-driver-secret-1.1.1-29.el7_0.7.x86_64    @updates
    Update                                   1.2.8-16.el7_1.2.x86_64    @updates
    Updated     libvirt-daemon-driver-storage-1.1.1-29.el7_0.7.x86_64   @updates
    Update                                    1.2.8-16.el7_1.2.x86_64   @updates
    Dep-Install libvirt-daemon-kvm-1.2.8-16.el7_1.2.x86_64              @updates
</pre></div>


<p>So once more I read the problematic log entry:</p>
<div class="highlight"><pre><span></span>failed to load module /usr/lib64/libvirt/connection-driver/libvirt_driver_storage.so /usr/lib64/libvirt/connection-driver/libvirt_driver_storage.so: symbol dm_task_get_info_wit
h_deferred_remove, version Base not defined in file libdevmapper.so.1.02 with link <span class="nb">time</span> reference
</pre></div>


<p>and decided to <strong>yum upgrade device-mapper-libs</strong>. Afterwards I restarted <strong>libvirtd</strong>
and everything started working perfectly.</p>
<p>This would not happen if I had updated all the libraries, but unfortunately 
all I wanted was <strong>virt-sysprep</strong> installed - not update'ing all packages.</p>
<p>Finally <a href="http://bugs.centos.org/view.php?id=8403">filed a bugrequest</a></p>
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
       var disqus_shortname = 'manycraft';
       var disqus_identifier = '2015/Apr/06/libvirt-daemon-driver-storage-bug-in-centos-7/';
       var disqus_url = '../../../../2015/Apr/06/libvirt-daemon-driver-storage-bug-in-centos-7/';
       (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] ||
             document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the comments.</noscript>
</article>
            </div>
        </div>

        <div id="sidebar">
            <h1><a href="http://maciej.lasyk.info" title="title">Many craft. Wow. Such create</a><br><img
                src="/theme/img/chunkybacon.png"></h1>
            <span class="description"> </span>
        </div>

        <div id="feedsbar">
            <ul>
            <li><a href="/feeds/rss.xml">RSS</a> | <a href="/feeds/atom.xml">Atom</a></li>
            </ul>
        </div>

        <div id="tagcloud">
        <nav>
            <ul class="tagcloud">
            </ul>
        </nav>
        </div>

        <div id="footer">
            <div id="credits">
                <span>Adapted from <a
                        href="http://wordpress.org/themes/monospace">Monospace</a>
                || Created with <a href="">Pelican</a> || Hosted with <a
                    href="http://docker.io/">Docker</a></span>
                <p>content copyrights &copy; Maciej Lasyk</p>
            </div>
                
        </div>

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-61452-19");
    pageTracker._trackPageview();
    } catch(err) {}</script>
<script type="text/javascript">
    var disqus_shortname = 'manycraft';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    </div>

</body>
</html>