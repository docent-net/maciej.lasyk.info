<!DOCTYPE html>
<html lang="en">
<head>
        <title>Many craft. Wow. Such create : Working with virtualenv and Ansible</title>
        <meta charset="utf-8" />
        <link rel="stylesheet" href="http://maciej.lasyk.info/theme/css/main.css" type="text/css" />
        <link href="http://maciej.lasyk.info/" type="application/atom+xml" rel="alternate" title="Many craft. Wow. Such create ATOM Feed" />
        <link href="http://maciej.lasyk.info/feeds/rss.xml" type="application/atom+xml" rel="alternate" title="Many craft. Wow. Such create RSS Feed" />

        <!--[if IE]>
                <script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

        <!--[if lte IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://maciej.lasyk.info/css/ie.css"/>
                <script src="http://maciej.lasyk.info/js/IE8.js" type="text/javascript"></script><![endif]-->

        <!--[if lt IE 7]>
                <link rel="stylesheet" type="text/css" media="all" href="http://maciej.lasyk.info/css/ie6.css"/><![endif]-->

</head>

<body>
	<div id="wrap" style="width:850px">
	    <div id="container" style="width:560px">


            <div class="entry">
        
<header>
<h1><a href="http://maciej.lasyk.info" id="site-title">  </a>         <a href="http://maciej.lasyk.info/2016/Jun/27/working-with-virtualenv-and-ansible/" id="page-title">Working with virtualenv and Ansible</a></h1>
<time datetime="2016-06-27T00:00:00+02:00">Mon 27 June 2016</time></header>
<article>
    <p><center><img alt="Evernote" src="http://maciej.lasyk.info/images/Ansible_Logo.png" /></center></p>
<h2>What this is about?</h2>
<p>So after upgrading to <a href="https://getfedora.org/?wkfpF24">Fedora 24</a> I wanted to have
a clean installation and use only system libraries (no more <strong>sudo pip install..</strong>).
I already achieved that by using
<a href="https://www.freedesktop.org/software/systemd/man/systemd-nspawn.html">systemd-nspawn containers</a>
for application isolation (instead of using virtual machines) and <a href="http://docs.python-guide.org/en/latest/dev/virtualenvs/">virtualenv</a>
for Python libraries during pydevelopment.</p>
<p>But.. while working with Ansible there's still a problem. E.g. when working with cloud
providers (like AWS, Google, Rackspace, Digital Ocean - you name it) you usually use
local connections for sending API requests, e.g.:</p>
<div class="highlight"><pre><span></span>- hosts: localhost
  connection: local
  tasks:
  - name: Provision a set of instances
    ec2:
        ...
</pre></div>


<p>In order to make above working you need to have <strong>boto</strong> and <strong>Ansible</strong> installed on
your box. That's a no - brainer.</p>
<p>But what if every ansible repository contains requirements.txt which declares specific
Ansible and boto versions? E.g.:</p>
<div class="highlight"><pre><span></span>ansible==2.0.1.0
boto==2.40.0
</pre></div>


<p>Yes, you could simply:</p>
<div class="highlight"><pre><span></span>sudo pip install ansible==2.0.1.0
sudo pip install boto==2.40.0
</pre></div>


<p>But this would actually break your system - wide libraries. If another project needs
<strong>ansible==2.1.0.0</strong> then you're in trouble.</p>
<h2>Ansible and virtualenv?</h2>
<p>So - the solution is to use <a href="http://docs.python-guide.org/en/latest/dev/virtualenvs/">Python virtualenv</a>.
It might be obvious, but it's not that easy with Ansible. When working from defined virtual environment
and using <strong>local</strong> connection Ansible actually creates SSH connection via loopback device and enters login shell
using configured account (e.g. <strong>remote_user</strong> set it ansible.cfg; more on this topic <a href="http://docs.ansible.com/ansible/intro_configuration.html#remote-user">here</a>.
After logging back in to your account we're using default Python interpreter (global one, probably <strong>/usr/bin/python</strong>) -
not the one we want to (from our virtualenv). Kaboom!</p>
<p>Ok, so there's a solution. It's called <strong>ansible_python_interpreter</strong> and it's mentioned
in <a href="http://docs.ansible.com/faq.html">Ansible FAQ</a> (but regarding other case). Basically
if we tell Ansible to use Python interpreter from our virtualenv it will work:</p>
<div class="highlight"><pre><span></span>ansible-playbook -i inventory/ec2.py magic_cloud.yml \
-e &quot;ansible_python_interpreter=/home/ukleftue/.virtualenvs/ilovebaleares/bin/python&quot;
</pre></div>


<p>In above example virtualenv we use is called <strong>ilovebaleares</strong>.</p>
<p>So using this hack'ish way we can marry Ansible and virtualenvs together.</p>
<h2>There's more to it!</h2>
<p>Remember that you can have couple of plays in playbook? Imagine, that first play
actually spawns instances (using API calls invoked from local tasks) and second one
applies roles using direct SSH connections to remote (freshly spawned) instances:</p>
<div class="highlight"><pre><span></span><span class="x">- hosts: localhost</span>
<span class="x">  connection: local</span>
<span class="x">  tasks:</span>
<span class="x">  - name: Provision a set of instances</span>
<span class="x">    ec2:</span>
<span class="x">        ...</span>
<span class="x">    register: ec2</span>

<span class="x">  - name: Add host to temporary group</span>
<span class="x">    add_host: &gt;</span>
<span class="x">      hostname=&quot;</span><span class="cp">{{</span> <span class="nv">item.private_ip</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">      groupname=&quot;tag_awesomehosts&quot;</span>
<span class="x">    with_items: &quot;</span><span class="cp">{{</span> <span class="nv">ec2.tagged_instances</span> <span class="cp">}}</span><span class="x">&quot;</span>
<span class="x">    changed_when: false</span>

<span class="x">- name: Configure instances</span>
<span class="x">  hosts:</span>
<span class="x">  - &quot;tag_awesomehosts&quot;</span>
<span class="x">  roles:</span>
<span class="x">    - do_something</span>
</pre></div>


<p>So in above example using <strong>ansible_python_interpreter</strong> will work for first play,
but for second it will cause:</p>
<p><strong>fatal: [some_ip_addr]: UNREACHABLE! =&gt; {"changed": false, "msg": "SSH Error: data could not be sent to the remote host. Make sure this host can be reached over ssh", "unreachable": true}</strong></p>
<p>Why is that? If we run ansible-playbook in verbose mode (add -vvvvv) we'll get:</p>
<div class="highlight"><pre><span></span>&lt;some_ip_addr&gt; SSH: EXEC ssh -C -vvv -o ControlMaster=auto
-o ControlPersist=60s -o StrictHostKeyChecking=no -o
KbdInteractiveAuthentication=no -o
PreferredAuthentications=gssapi-with-mic,gssapi-keyex,hostbased,
publickey -o PasswordAuthentication=no -o User=ec2-user
-o ConnectTimeout=20 -o ControlPath=/tmp/ansible-ssh-%h-%p-%r some_ip_addr
&#39;/bin/sh -c &#39;&quot;&#39;&quot;&#39;sudo -H -S -n -u root /bin/sh -c &#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;echo
BECOME-SUCCESS; /bin/sh -c &#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;
LANG=C LC_ALL=C LC_MESSAGES=C
/home/ukleftue//.virtualenvs/ilovebaleares/bin/python&#39;
&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&quot;&#39;&#39;&quot;&#39;&quot;&#39;&#39;
</pre></div>


<p>Notice last: <strong>/home/ukleftue//.virtualenvs/ilovebaleares/bin/python</strong> - see? This is
our problem - setting <strong>ansible_python_interpreter</strong> works globally for all plays
within playbook.</p>
<p>So I found solution for this - actually you can set <strong>ansible_python_interpreter</strong> per
host basis in inventory (told you that sometimes when I don't hate Ansible I really
love it?). So just prepare yourself file like <strong>inventory/local</strong> which could look
like this:</p>
<div class="highlight"><pre><span></span><span class="k">[localhost]</span>
<span class="na">localhost ansible_python_interpreter</span><span class="o">=</span><span class="s">/home/ukleftue/.virtualenvs/ilovebaleares/bin/python</span>
</pre></div>


<p>and run above playbook without passing directly <strong>ansible_python_interpreter</strong> on command
line (as it is already set in inventory), but providing additional inventory file:</p>
<div class="highlight"><pre><span></span>ansible-playbook -i inventory/ec2.py -i inventory/local magic_cloud.yml&quot;
</pre></div>


<h2>Whoah, that really works?</h2>
<p>Erm, SOA#1: Works for me ;)</p>
<p>Enjoy!</p>
    <h2>Comments</h2>
    <div id="disqus_thread"></div>
    <script type="text/javascript">
       var disqus_shortname = 'manycraft';
       var disqus_identifier = '2016/Jun/27/working-with-virtualenv-and-ansible/';
       var disqus_url = 'http://maciej.lasyk.info/2016/Jun/27/working-with-virtualenv-and-ansible/';
       (function() {
            var dsq = document.createElement('script');
            dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] ||
             document.getElementsByTagName('body')[0]).appendChild(dsq);
      })();
    </script>
    <noscript>Please enable JavaScript to view the comments.</noscript>
</article>
            </div>
        </div>

        <div id="sidebar">
            <h1><a href="http://maciej.lasyk.info" title="title">Many craft. Wow. Such create</a><br><img
                src="/theme/img/chunkybacon.png"></h1>
            <span class="description"> </span>
        </div>

        <div id="feedsbar">
            <ul>
            <li><a href="/feeds/rss.xml">RSS</a> | <a href="/feeds/atom.xml">Atom</a></li>
            </ul>
        </div>

        <div id="tagcloud">
        <nav>
            <ul class="tagcloud">
            </ul>
        </nav>
        </div>

        <div id="footer">
            <div id="credits">
                <span>Adapted from <a
                        href="http://wordpress.org/themes/monospace">Monospace</a>
                || Created with <a href="">Pelican</a> || Hosted with <a
                    href="http://docker.io/">Docker</a></span>
                <p>content copyrights &copy; Maciej Lasyk</p>
            </div>
                
        </div>

    <script type="text/javascript">
    var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
    document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
    try {
        var pageTracker = _gat._getTracker("UA-61452-19");
    pageTracker._trackPageview();
    } catch(err) {}</script>
    <script type="text/javascript">
        var pkBaseURL = (("https:" == document.location.protocol) ? "https://analytics.lasyk.info/" : "http://analytics.lasyk.info/");
    document.write(unescape("%3Cscript src='" + pkBaseURL + "piwik.js' type='text/javascript'%3E%3C/script%3E"));
    </script><script type="text/javascript">
    try {
    var piwikTracker = Piwik.getTracker(pkBaseURL + "piwik.php", 1);
    piwikTracker.trackPageView();
    piwikTracker.enableLinkTracking();
    } catch( err ) {}
    </script><noscript><p><img src="http://analytics.lasyk.info/piwik.php?idsite=1" style="border:0" alt="" /></p></noscript>
<script type="text/javascript">
    var disqus_shortname = 'manycraft';
    (function () {
        var s = document.createElement('script'); s.async = true;
        s.type = 'text/javascript';
        s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
        (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
    }());
</script>

    </div>

</body>
</html>